#!/bin/bash

# ============================================================================
# Kubernetes Complete Installation Script
# ============================================================================
# Generated from template - DO NOT EDIT DIRECTLY
# Kubernetes Version: {{ k8s_version }}
# Containerd Version: {{ containerd_version }}
# Architecture: {{ arch }}
# CNI Provider: {{ cni_provider }}
# ============================================================================

set -e

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${GREEN}[✓] $1${NC}"; }
error() { echo -e "${RED}[✗] ERROR: $1${NC}"; exit 1; }
info() { echo -e "${BLUE}[ℹ] $1${NC}"; }
warning() { echo -e "${YELLOW}[⚠] $1${NC}"; }
section() { echo -e "${CYAN}═══ $1 ═══${NC}"; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check root
[[ $EUID -ne 0 ]] && error "This script must be run as root"

echo ""
section "Kubernetes Complete Installation"
echo ""

# ========================= SYSTEM PACKAGES =========================

section "Step 1/9: Installing System Packages"

if [[ -f "$SCRIPT_DIR/scripts/install-apt.sh" ]] && [[ -d "$SCRIPT_DIR/packages/apt" ]]; then
    cd "$SCRIPT_DIR/packages/apt"
    # Set aggressive non-interactive environment for dpkg
    export DEBIAN_FRONTEND=noninteractive
    export DEBCONF_NONINTERACTIVE_SEEN=true
    export DEBIAN_PRIORITY=critical
    export APT_LISTCHANGES_FRONTEND=none
    bash "$SCRIPT_DIR/scripts/install-apt.sh"
    log "System packages installed"
else
    warning "System packages not found, skipping..."
fi

# ========================= PIP PACKAGES =========================

section "Step 2/9: Installing Python Packages"

if [[ -f "$SCRIPT_DIR/scripts/install-pip.sh" ]] && [[ -d "$SCRIPT_DIR/packages/pip" ]]; then
    bash "$SCRIPT_DIR/scripts/install-pip.sh"
    log "Python packages installed"
else
    warning "Python packages not found, skipping..."
fi

# ========================= KERNEL MODULES =========================

section "Step 3/9: Configuring Kernel Modules"

if [[ -f "$SCRIPT_DIR/config/k8s-modules.conf" ]]; then
    cp "$SCRIPT_DIR/config/k8s-modules.conf" /etc/modules-load.d/

    # Load modules
    while IFS= read -r module; do
        [[ "$module" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$module" ]] && continue
        modprobe "$module" 2>/dev/null || warning "Failed to load: $module"
    done < /etc/modules-load.d/k8s-modules.conf

    log "Kernel modules configured"
fi

# ========================= SYSCTL =========================

section "Step 4/9: Applying Sysctl Settings"

if [[ -f "$SCRIPT_DIR/config/k8s-sysctl.conf" ]]; then
    cp "$SCRIPT_DIR/config/k8s-sysctl.conf" /etc/sysctl.d/99-k8s.conf
    sysctl --system >/dev/null
    log "Sysctl settings applied"
fi

# ========================= DISABLE SWAP =========================

section "Step 5/9: Disabling Swap"

swapoff -a
sed -i '/ swap / s/^/#/' /etc/fstab
log "Swap disabled"

# ========================= CONTAINERD =========================

section "Step 6/9: Installing Containerd"

if [[ -d "$SCRIPT_DIR/binaries/containerd" ]]; then
    cd "$SCRIPT_DIR/binaries/containerd"

    # Extract containerd
    tar -xzf containerd-*.tar.gz -C /usr/local

    # Install runc
    install -m 755 runc /usr/local/sbin/runc

    # Install systemd service
    mkdir -p /etc/systemd/system
    cp containerd.service /etc/systemd/system/

    # Configure containerd
    mkdir -p /etc/containerd
    if [[ -f "$SCRIPT_DIR/config/containerd-config.toml" ]]; then
        cp "$SCRIPT_DIR/config/containerd-config.toml" /etc/containerd/config.toml
    else
        containerd config default > /etc/containerd/config.toml
    fi

    # Start containerd
    systemctl daemon-reload
    systemctl enable containerd
    systemctl start containerd

    log "Containerd installed and started"
else
    warning "Containerd binaries not found"
fi

# ========================= CNI PLUGINS =========================

section "Step 7/9: Installing CNI Plugins"

if [[ -d "$SCRIPT_DIR/binaries/cni" ]]; then
    mkdir -p /opt/cni/bin
    cd "$SCRIPT_DIR/binaries/cni"
    tar -xzf cni-plugins-*.tgz -C /opt/cni/bin
    log "CNI plugins installed"
{% if cni_provider != 'none' %}

    # Install CNI network provider manifest: {{ cni_provider }}
    if [[ -f "{{ cni_provider }}.yaml" ]]; then
        info "{{ cni_provider|capitalize }} manifest available at: $SCRIPT_DIR/binaries/cni/{{ cni_provider }}.yaml"
        info "Apply after cluster initialization with:"
        info "  kubectl apply -f $SCRIPT_DIR/binaries/cni/{{ cni_provider }}.yaml"
    else
        warning "{{ cni_provider|capitalize }} manifest not found"
    fi
{% else %}
    info "CNI provider set to 'none' - will be installed separately (e.g., via Helm)"
{% endif %}
fi

# ========================= KUBERNETES BINARIES =========================

section "Step 8/9: Installing Kubernetes Binaries"

if [[ -d "$SCRIPT_DIR/binaries/kubernetes" ]]; then
    cd "$SCRIPT_DIR/binaries/kubernetes"

    # Install binaries to /usr/bin (required by systemd service)
    install -m 755 kubeadm /usr/bin/
    install -m 755 kubelet /usr/bin/
    install -m 755 kubectl /usr/bin/

    # Install crictl to /usr/local/bin (standard location)
    if [[ -f crictl ]]; then
        install -m 755 crictl /usr/local/bin/
        log "crictl installed to /usr/local/bin"
    fi

    # Configure crictl
    if [[ -f "$SCRIPT_DIR/config/crictl.yaml" ]]; then
        mkdir -p /etc
        cp "$SCRIPT_DIR/config/crictl.yaml" /etc/crictl.yaml
        log "crictl configured"
    fi

    # Install kubelet systemd service
    mkdir -p /etc/systemd/system/kubelet.service.d
    cp kubelet.service /etc/systemd/system/
    cp 10-kubeadm.conf /etc/systemd/system/kubelet.service.d/

    # Enable kubelet
    systemctl daemon-reload
    systemctl enable kubelet

    log "Kubernetes binaries installed"
else
    error "Kubernetes binaries not found"
fi

# ========================= CONTAINER IMAGES =========================

section "Step 9/9: Loading Container Images"

if [[ -f "$SCRIPT_DIR/images/images.txt" ]]; then
    info "Container images will be pulled by kubeadm"
    info "To pre-pull images, run: kubeadm config images pull"
fi

# ========================= VERIFICATION =========================

section "Verification"

echo ""
info "Checking installation..."

# Check binaries
for cmd in kubeadm kubelet kubectl; do
    if command -v $cmd &>/dev/null; then
        version=$($cmd version --short 2>/dev/null | head -1 || echo "installed")
        echo "  ✓ $cmd: $version"
    else
        echo "  ✗ $cmd: not found"
    fi
done

# Check crictl
if command -v crictl &>/dev/null; then
    crictl_version=$(crictl --version 2>/dev/null | awk '{print $NF}' || echo "installed")
    echo "  ✓ crictl: $crictl_version"
else
    echo "  ✗ crictl: not found"
fi

# Check containerd
if systemctl is-active containerd &>/dev/null; then
    echo "  ✓ containerd: running"
else
    echo "  ✗ containerd: not running"
fi

# Check ctr (comes with containerd)
if command -v ctr &>/dev/null; then
    echo "  ✓ ctr: installed"
else
    echo "  ✗ ctr: not found"
fi

# Check modules
for mod in overlay br_netfilter ip_vs; do
    if lsmod | grep -q "^${mod}"; then
        echo "  ✓ $mod module loaded"
    else
        echo "  ✗ $mod module not loaded"
    fi
done

# Check swap
if swapon --show | grep -q '/'; then
    echo "  ✗ swap still enabled"
else
    echo "  ✓ swap disabled"
fi

echo ""
echo -e "${GREEN}"
echo "═══════════════════════════════════════════════════════════════"
echo "  Kubernetes Installation Complete!"
echo "═══════════════════════════════════════════════════════════════"
echo -e "${NC}"
echo ""
info "Next steps:"
echo "  1. Initialize cluster (master node):"
echo "     kubeadm init --pod-network-cidr=10.244.0.0/16"
echo ""
echo "  2. Configure kubectl:"
echo "     mkdir -p \$HOME/.kube"
echo "     cp /etc/kubernetes/admin.conf \$HOME/.kube/config"
echo "     chown \$(id -u):\$(id -g) \$HOME/.kube/config"
echo ""
{% if cni_provider != 'none' %}
echo "  3. Apply CNI network provider:"
echo "     kubectl apply -f \$SCRIPT_DIR/binaries/cni/{{ cni_provider }}.yaml"
echo ""
echo "  4. Join worker nodes:"
{% else %}
echo "  3. Install CNI (e.g., via Helm):"
echo "     # See CNI-HELM-CHART-GUIDE.md for instructions"
echo ""
echo "  4. Join worker nodes:"
{% endif %}
echo "     kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash <hash>"
echo ""
